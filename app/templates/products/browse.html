{% extends "base.html" %}

{% block title %}Browse Products - {{ trader.business_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="bi bi-search"></i> Browse & Add Products</h2>
            <p class="text-muted">Select products to add to your catalog</p>
        </div>
        <div class="col-md-6 text-end">
            <a href="/products" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i> Back to Products
            </a>
            <button class="btn btn-primary" id="view-cart-btn">
                <i class="bi bi-cart"></i> View Cart
                <span class="badge bg-light text-dark" id="cart-count">{{ cart_count }}</span>
            </button>
        </div>
    </div>

    <!-- Backend Not Ready Warning Banner -->
    <div class="alert alert-warning alert-dismissible fade show" role="alert" id="backend-warning">
        <i class="bi bi-exclamation-triangle"></i>
        <strong>Backend endpoints not ready yet!</strong>
        The browse products feature is under development. You can still use the "Sync All Products" button on the products page.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Filters Row -->
    <div class="row mb-4">
        <div class="col-md-4">
            <label for="category-filter" class="form-label">Filter by Category</label>
            <select class="form-select" id="category-filter">
                <option value="">All Categories</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="search-input" class="form-label">Search Products</label>
            <input type="text" class="form-control" id="search-input" placeholder="Search by product name...">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100" id="search-btn">
                <i class="bi bi-search"></i> Search
            </button>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="row" id="products-grid">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading products...</p>
        </div>
    </div>

    <!-- Pagination -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Product pagination">
                <ul class="pagination justify-content-center" id="pagination">
                </ul>
            </nav>
        </div>
    </div>

    <!-- Floating Save Button -->
    <div class="position-fixed bottom-0 end-0 p-4" style="z-index: 1000;">
        <button class="btn btn-success btn-lg shadow" id="save-selection-btn" style="display: none;">
            <i class="bi bi-check-circle"></i> Save Selected Products
        </button>
    </div>
</div>

<!-- Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cartModalLabel">
                    <i class="bi bi-cart"></i> Selection Cart
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="cart-modal-body">
                <div class="text-center py-4">
                    <p class="text-muted">Your cart is empty</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" id="clear-cart-btn">
                    <i class="bi bi-trash"></i> Clear Cart
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="save-from-modal-btn">
                    <i class="bi bi-check-circle"></i> Save Selection
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.product-card {
    transition: transform 0.2s, box-shadow 0.2s;
    height: 100%;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.product-card.selected {
    border: 2px solid #198754;
    background-color: #f0f9f4;
}

.product-card .card-img-top {
    height: 200px;
    object-fit: cover;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 3rem;
}

.stock-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
}

.price-tag {
    font-size: 1.5rem;
    font-weight: bold;
    color: #198754;
}
</style>

<script>
let currentPage = 1;
let selectedCategory = null;
let searchQuery = null;
let cart = {{ cart_count }};
let cartModal = null;
let browseCache = [];

document.addEventListener('DOMContentLoaded', function() {
    cartModal = new bootstrap.Modal(document.getElementById('cartModal'));

    // Load initial data
    loadCategories();
    loadProducts();

    // Event listeners
    document.getElementById('category-filter').addEventListener('change', function(e) {
        selectedCategory = e.target.value || null;
        currentPage = 1;
        loadProducts();
    });

    document.getElementById('search-btn').addEventListener('click', function() {
        searchQuery = document.getElementById('search-input').value || null;
        currentPage = 1;
        loadProducts();
    });

    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchQuery = this.value || null;
            currentPage = 1;
            loadProducts();
        }
    });

    document.getElementById('view-cart-btn').addEventListener('click', function() {
        showCart();
    });

    document.getElementById('save-selection-btn').addEventListener('click', function() {
        saveSelection();
    });

    document.getElementById('save-from-modal-btn').addEventListener('click', function() {
        saveSelection();
    });

    document.getElementById('clear-cart-btn').addEventListener('click', function() {
        clearCart();
    });
});

async function loadCategories() {
    try {
        const response = await fetch('/api/v1/browse/categories');
        if (response.status === 501) {
            console.log('Backend categories endpoint not ready');
            return;
        }

        if (response.ok) {
            const categories = await response.json();
            const select = document.getElementById('category-filter');

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.sourceId;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

async function loadProducts() {
    const grid = document.getElementById('products-grid');
    grid.innerHTML = `
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading products...</p>
        </div>
    `;

    try {
        let url = `/api/v1/browse/products?page=${currentPage}&limit=12`;
        if (selectedCategory) url += `&category_id=${selectedCategory}`;
        if (searchQuery) url += `&search=${encodeURIComponent(searchQuery)}`;

        const response = await fetch(url);

        if (response.status === 501) {
            grid.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-exclamation-circle text-warning" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">Backend Not Ready</h4>
                    <p class="text-muted">The browse products endpoint is not implemented yet.</p>
                    <a href="/products" class="btn btn-primary">
                        <i class="bi bi-arrow-left"></i> Back to Products
                    </a>
                </div>
            `;
            return;
        }

        if (response.ok) {
            const data = await response.json();
            browseCache = data.products;
            displayProducts(data.products);
            updatePagination(data.page, data.totalPages);
        } else {
            throw new Error('Failed to load products');
        }
    } catch (error) {
        console.error('Error loading products:', error);
        grid.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-exclamation-triangle text-danger" style="font-size: 4rem;"></i>
                <h4 class="mt-3">Error Loading Products</h4>
                <p class="text-muted">${error.message}</p>
            </div>
        `;
    }
}

function displayProducts(products) {
    const grid = document.getElementById('products-grid');

    if (products.length === 0) {
        grid.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                <h4 class="mt-3">No Products Found</h4>
                <p class="text-muted">Try adjusting your filters or search query.</p>
            </div>
        `;
        return;
    }

    grid.innerHTML = products.map(product => `
        <div class="col-md-4 col-lg-3 mb-4">
            <div class="card product-card" data-product-id="${product.sourceId}">
                <div class="position-relative">
                    <div class="card-img-top">
                        <i class="bi bi-box-seam"></i>
                    </div>
                    <span class="badge ${product.centralStock > 0 ? 'bg-success' : 'bg-danger'} stock-badge">
                        Stock: ${product.centralStock}
                    </span>
                </div>
                <div class="card-body">
                    <h6 class="card-title" title="${product.title}">${truncate(product.title, 50)}</h6>
                    <p class="text-muted small mb-2">
                        <i class="bi bi-tag"></i> ${product.category.name}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="price-tag">$${parseFloat(product.price).toFixed(2)}</span>
                        <button class="btn btn-sm btn-outline-success add-to-cart-btn"
                                data-product-id="${product.sourceId}"
                                onclick="toggleProductInCart(${product.sourceId})">
                            <i class="bi bi-plus-circle"></i> Add
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    // Highlight selected products
    highlightSelectedProducts();
}

function highlightSelectedProducts() {
    fetch('/api/v1/browse/cart')
        .then(res => res.json())
        .then(data => {
            const cartItems = data.cart;
            document.querySelectorAll('.product-card').forEach(card => {
                const productId = parseInt(card.dataset.productId);
                const btn = card.querySelector('.add-to-cart-btn');

                if (cartItems.includes(productId)) {
                    card.classList.add('selected');
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Added';
                    btn.classList.remove('btn-outline-success');
                    btn.classList.add('btn-success');
                } else {
                    card.classList.remove('selected');
                    btn.innerHTML = '<i class="bi bi-plus-circle"></i> Add';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-success');
                }
            });
        });
}

async function toggleProductInCart(productId) {
    try {
        const response = await fetch('/api/v1/browse/cart');
        const data = await response.json();
        const isInCart = data.cart.includes(productId);

        const endpoint = isInCart ? '/api/v1/browse/cart/remove' : '/api/v1/browse/cart/add';
        const result = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({productSourceIds: [productId]})
        });

        if (result.ok) {
            const cartData = await result.json();
            updateCartCount(cartData.count);
            highlightSelectedProducts();
        }
    } catch (error) {
        console.error('Error toggling cart:', error);
    }
}

function updateCartCount(count) {
    document.getElementById('cart-count').textContent = count;
    cart = count;

    // Show/hide save button
    const saveBtn = document.getElementById('save-selection-btn');
    saveBtn.style.display = count > 0 ? 'block' : 'none';
}

function updatePagination(currentPageNum, totalPages) {
    const pagination = document.getElementById('pagination');

    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '';

    // Previous button
    html += `
        <li class="page-item ${currentPageNum === 0 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPageNum}); return false;">Previous</a>
        </li>
    `;

    // Page numbers
    for (let i = 0; i < totalPages; i++) {
        html += `
            <li class="page-item ${currentPageNum === i ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i + 1}); return false;">${i + 1}</a>
            </li>
        `;
    }

    // Next button
    html += `
        <li class="page-item ${currentPageNum === totalPages - 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPageNum + 2}); return false;">Next</a>
        </li>
    `;

    pagination.innerHTML = html;
}

function changePage(page) {
    currentPage = page;
    loadProducts();
    window.scrollTo(0, 0);
}

async function showCart() {
    try {
        const response = await fetch('/api/v1/browse/cart');
        const data = await response.json();

        const modalBody = document.getElementById('cart-modal-body');

        if (data.count === 0) {
            modalBody.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-cart-x text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">Your cart is empty</p>
                </div>
            `;
        } else {
            const selectedProducts = browseCache.filter(p => data.cart.includes(p.sourceId));

            modalBody.innerHTML = `
                <div class="list-group">
                    ${selectedProducts.map(product => `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${product.title}</h6>
                                    <small class="text-muted">${product.category.name} â€¢ $${parseFloat(product.price).toFixed(2)}</small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${product.sourceId})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>${data.count}</strong> product(s) selected
                </div>
            `;
        }

        cartModal.show();
    } catch (error) {
        console.error('Error loading cart:', error);
    }
}

async function removeFromCart(productId) {
    try {
        const response = await fetch('/api/v1/browse/cart/remove', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({productSourceIds: [productId]})
        });

        if (response.ok) {
            const data = await response.json();
            updateCartCount(data.count);
            showCart();
            highlightSelectedProducts();
        }
    } catch (error) {
        console.error('Error removing from cart:', error);
    }
}

async function clearCart() {
    if (!confirm('Are you sure you want to clear your cart?')) return;

    try {
        const response = await fetch('/api/v1/browse/cart/clear', {
            method: 'POST'
        });

        if (response.ok) {
            updateCartCount(0);
            cartModal.hide();
            highlightSelectedProducts();
        }
    } catch (error) {
        console.error('Error clearing cart:', error);
    }
}

async function saveSelection() {
    if (cart === 0) {
        alert('Your cart is empty. Add some products first.');
        return;
    }

    if (!confirm(`Save ${cart} selected product(s) to your catalog?`)) return;

    try {
        const response = await fetch('/api/v1/browse/cart/save', {
            method: 'POST'
        });

        if (response.ok) {
            const result = await response.json();
            alert(`Success! ${result.saved} product(s) saved to your catalog.\n\nCreated: ${result.created}\nUpdated: ${result.updated}`);
            window.location.href = '/products';
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error saving selection:', error);
        alert('Error saving selection. Please try again.');
    }
}

function truncate(str, maxLength) {
    return str.length > maxLength ? str.substring(0, maxLength) + '...' : str;
}
</script>
{% endblock %}
